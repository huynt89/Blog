name: System Processor
on:
  push:
    paths:
      - 'requests/*.json'

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Transform Request to Post
        run: |
          mkdir -p Pages/PC/img Pages/MAC/img Pages/Mobile/img Pages/Other/img
          
          # Lấy file json mới nhất
          JSON_FILE=$(ls requests/*.json | head -n 1)
          
          # Trích xuất dữ liệu bằng jq
          TITLE=$(jq -r '.title' $JSON_FILE)
          CAT=$(jq -r '.category' $JSON_FILE)
          SUMMARY=$(jq -r '.summary' $JSON_FILE)
          IMG_DATA=$(jq -r '.image_data' $JSON_FILE)
          
          # Tạo slug không dấu
          SLUG=$(echo "$TITLE" | iconv -t ascii//TRANSLIT | sed -r 's/[^a-zA-Z0-9]+/-/g' | tr '[:upper:]' '[:lower:]')
          DATE=$(date +'%Y-%m-%d')
          
          # Đường dẫn file
          JS_PATH="Pages/$CAT/data${CAT}_${SLUG}_${DATE}.js"
          IMG_PATH="Pages/$CAT/img/${SLUG}.jpg"

          # Lưu ảnh và file JS
          echo $IMG_DATA | base64 -d > $IMG_PATH
          echo "window.lastLoadedPost = { title: \"$TITLE\", summary: \"$SUMMARY\", image: \"$IMG_PATH\", category: \"$CAT\", date: \"$DATE\" };" > $JS_PATH
          
          # Xóa request
          rm $JSON_FILE

          # Cập nhật file database.json
          echo "{\"posts\": [" > database.json
          find Pages -name "data*.js" | sed 's/^/"/;s/$/"/' | paste -sd "," - >> database.json
          echo "]}" >> database.json

      - name: Commit & Deploy
        run: |
          git config --global user.name "System Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Auto-post: New article added"
          git push origin main