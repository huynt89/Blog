name: Auto Publish News
on:
  issues:
    types: [opened]

jobs:
  publish:
    if: contains(github.event.issue.labels.*.name, 'new-post')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v3

      - name: Parse Issue and Create File
        run: |
          # Lấy nội dung Issue
          BODY="${{ github.event.issue.body }}"
          
          # Trích xuất thông tin bằng lệnh sed/grep
          TITLE=$(echo "$BODY" | grep "TITLE:" | cut -d':' -f2- | xargs)
          CAT=$(echo "$BODY" | grep "CATEGORY:" | cut -d':' -f2- | xargs)
          IMG=$(echo "$BODY" | grep "IMAGE:" | cut -d':' -f2- | xargs)
          SUMMARY=$(echo "$BODY" | grep "SUMMARY:" | cut -d':' -f2- | xargs)
          DATE=$(date +'%Y-%m-%d')
          
          # Tạo tên file chuẩn
          SLUG=$(echo "$TITLE" | iconv -t ascii//TRANSLIT | sed -E 's/[^a-zA-Z0-9]+/-/g' | tr '[:upper:]' '[:lower:]')
          FILE_NAME="data${CAT}_${SLUG}_${DATE}.js"
          FILE_PATH="Pages/${CAT}/${FILE_NAME}"

          # Tạo nội dung file JS
          echo "renderPost({
            title: \"$TITLE\",
            category: \"$CAT\",
            image: \"$IMG\",
            summary: \"$SUMMARY\",
            date: \"$DATE\"
          });" > $FILE_PATH

          # Cập nhật database.js
          sed -i "s|];|    \"$FILE_PATH\",\n];|" database.js

          # Commit và Push
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add .
          git commit -m "New Post: $TITLE"
          git push

      - name: Close Issue
        run: gh issue close ${{ github.event.issue.number }} --comment "Bài viết đã được xuất bản tự động!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
